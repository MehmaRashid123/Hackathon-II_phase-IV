openapi: 3.0.0
info:
  title: Pro Task Engine API v2
  version: 2.0.0
  description: API for advanced task management, including subtasks, rich metadata, and collaboration features.

servers:
  - url: /api/{user_id}
    variables:
      user_id:
        default: 00000000-0000-0000-0000-000000000000
        description: The UUID of the authenticated user.

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    UUID:
      type: string
      format: uuid
      example: "123e4567-e89b-12d3-a456-426614174000"
    DateTime:
      type: string
      format: date-time
      example: "2026-02-05T10:30:00Z"

    # Enums
    PriorityEnum:
      type: string
      enum: [LOW, MEDIUM, HIGH, URGENT]
      example: MEDIUM
    StatusEnum:
      type: string
      enum: [TO_DO, IN_PROGRESS, REVIEW, BLOCKED, DONE]
      example: TO_DO

    # Task Schemas
    TaskBase:
      type: object
      properties:
        title:
          type: string
          minLength: 1
        description:
          type: string
          nullable: true
        is_completed:
          type: boolean
          default: false
        parent_id:
          $ref: '#/components/schemas/UUID'
          nullable: true
        priority:
          $ref: '#/components/schemas/PriorityEnum'
        status:
          $ref: '#/components/schemas/StatusEnum'
        due_date:
          $ref: '#/components/schemas/DateTime'
          nullable: true
        recurrence_rule:
          type: string
          nullable: true
          description: Simplified string for recurrence (e.g., DAILY, WEEKLY:MON)
        section_id:
          $ref: '#/components/schemas/UUID'
          nullable: true
        project_id:
          $ref: '#/components/schemas/UUID'
          nullable: true
      required:
        - title
        - priority
        - status

    TaskCreate:
      allOf:
        - $ref: '#/components/schemas/TaskBase'
      type: object
      properties:
        parent_id:
          $ref: '#/components/schemas/UUID'
          nullable: true
          description: ID of the parent task if this is a subtask.
      required:
        - title
        - priority
        - status

    TaskUpdate:
      allOf:
        - $ref: '#/components/schemas/TaskBase'
      type: object
      properties:
        title:
          type: string
          minLength: 1
          nullable: true
        priority:
          $ref: '#/components/schemas/PriorityEnum'
          nullable: true
        status:
          $ref: '#/components/schemas/StatusEnum'
          nullable: true
      required: []

    TaskResponse:
      allOf:
        - $ref: '#/components/schemas/TaskBase'
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        user_id:
          $ref: '#/components/schemas/UUID'
        created_at:
          $ref: '#/components/schemas/DateTime'
        updated_at:
          $ref: '#/components/schemas/DateTime'
        subtasks:
          type: array
          items:
            $ref: '#/components/schemas/TaskResponse' # Recursive definition for nested subtasks
        tags:
          type: array
          items:
            $ref: '#/components/schemas/TagResponse'
      required:
        - id
        - user_id
        - created_at
        - updated_at
        - title
        - is_completed
        - priority
        - status

    # Comment Schemas
    CommentCreate:
      type: object
      properties:
        content:
          type: string
          minLength: 1
      required:
        - content

    CommentResponse:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        task_id:
          $ref: '#/components/schemas/UUID'
        user_id:
          $ref: '#/components/schemas/UUID'
        content:
          type: string
        created_at:
          $ref: '#/components/schemas/DateTime'
      required:
        - id
        - task_id
        - user_id
        - content
        - created_at

    # Tag Schemas
    TagResponse:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        name:
          type: string
        user_id:
          $ref: '#/components/schemas/UUID'
      required:
        - id
        - name
        - user_id

    # Project Schemas
    ProjectCreate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
      required:
        - name

    ProjectResponse:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        name:
          type: string
        user_id:
          $ref: '#/components/schemas/UUID'
        created_at:
          $ref: '#/components/schemas/DateTime'
        updated_at:
          $ref: '#/components/schemas/DateTime'
      required:
        - id
        - name
        - user_id
        - created_at
        - updated_at

    # Section Schemas
    SectionCreate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
        order:
          type: integer
          description: Order of the section within the project.
      required:
        - name
        - order

    SectionResponse:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        project_id:
          $ref: '#/components/schemas/UUID'
        name:
          type: string
        order:
          type: integer
        created_at:
          $ref: '#/components/schemas/DateTime'
        updated_at:
          $ref: '#/components/schemas/DateTime'
      required:
        - id
        - project_id
        - name
        - order
        - created_at
        - updated_at

    # Activity Log Schemas
    ActivityLogResponse:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        task_id:
          $ref: '#/components/schemas/UUID'
        user_id:
          $ref: '#/components/schemas/UUID'
          nullable: true
        event_type:
          type: string
          description: Type of activity (e.g., status_changed, comment_added)
        details:
          type: object
          description: JSON object with event-specific details
        created_at:
          $ref: '#/components/schemas/DateTime'
      required:
        - id
        - task_id
        - event_type
        - created_at

    # Dependency Schemas
    DependencyCreate:
      type: object
      properties:
        depends_on_task_id:
          $ref: '#/components/schemas/UUID'
          description: ID of the prerequisite task.
      required:
        - depends_on_task_id

    DependencyResponse:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UUID'
        task_id:
          $ref: '#/components/schemas/UUID'
        depends_on_task_id:
          $ref: '#/components/schemas/UUID'
        user_id:
          $ref: '#/components/schemas/UUID'
        created_at:
          $ref: '#/components/schemas/DateTime'
      required:
        - id
        - task_id
        - depends_on_task_id
        - user_id
        - created_at

paths:
  /tasks:
    get:
      summary: Get all tasks for the authenticated user, with optional filtering and subtask inclusion.
      operationId: getTasks
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/StatusEnum'
        - in: query
          name: priority
          schema:
            $ref: '#/components/schemas/PriorityEnum'
        - in: query
          name: tag
          schema:
            type: string
            description: Filter tasks by tag name.
        - in: query
          name: parent_id
          schema:
            $ref: '#/components/schemas/UUID'
            nullable: true
            description: Filter for top-level tasks or direct subtasks of a specific parent.
        - in: query
          name: include_subtasks
          schema:
            type: boolean
            default: false
            description: If true, recursively includes all subtasks for each returned task.
      responses:
        "200":
          description: A list of tasks.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TaskResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'

    post:
      summary: Create a new task for the authenticated user.
      operationId: createTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        "201":
          description: Task created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "400":
          $ref: '#/components/responses/BadRequestError'

  /tasks/{task_id}:
    parameters:
      - in: path
        name: task_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the task to retrieve or modify.
    get:
      summary: Get details of a specific task.
      operationId: getTaskById
      responses:
        "200":
          description: Task details.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
    put:
      summary: Update an existing task.
      operationId: updateTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        "200":
          description: Task updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "400":
          $ref: '#/components/responses/BadRequestError'
    delete:
      summary: Delete a task and all its subtasks.
      operationId: deleteTask
      responses:
        "200":
          description: Task and all subtasks deleted successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /tasks/{task_id}/complete:
    parameters:
      - in: path
        name: task_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the task to mark complete/incomplete.
    patch:
      summary: Toggle completion status of a task.
      operationId: toggleTaskCompletion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                is_completed:
                  type: boolean
              required:
                - is_completed
      responses:
        "200":
          description: Task completion status updated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "400":
          description: Bad request (e.g., dependency not fulfilled).
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string

  /tasks/{task_id}/comments:
    parameters:
      - in: path
        name: task_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the task to add comments to.
    post:
      summary: Add a new comment to a task.
      operationId: addCommentToTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommentCreate'
      responses:
        "201":
          description: Comment added successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
    get:
      summary: Get all comments for a task.
      operationId: getCommentsForTask
      responses:
        "200":
          description: List of comments.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CommentResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /tasks/{task_id}/activity:
    parameters:
      - in: path
        name: task_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the task to retrieve activity logs for.
    get:
      summary: Get activity logs for a specific task.
      operationId: getActivityLogsForTask
      responses:
        "200":
          description: List of activity logs.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ActivityLogResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /tasks/{task_id}/dependencies:
    parameters:
      - in: path
        name: task_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the dependent task.
    post:
      summary: Add a dependency to a task.
      operationId: addDependency
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DependencyCreate'
      responses:
        "201":
          description: Dependency added successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DependencyResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "400":
          description: Bad request (e.g., circular dependency).
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail:
                    type: string
    get:
      summary: Get all dependencies for a task.
      operationId: getDependencies
      responses:
        "200":
          description: List of dependencies.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DependencyResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /tasks/{task_id}/dependencies/{dependency_id}:
    parameters:
      - in: path
        name: task_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the dependent task.
      - in: path
        name: dependency_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the dependency relationship to delete.
    delete:
      summary: Remove a dependency from a task.
      operationId: removeDependency
      responses:
        "200":
          description: Dependency removed successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /projects:
    post:
      summary: Create a new project for the authenticated user.
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreate'
      responses:
        "201":
          description: Project created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "400":
          $ref: '#/components/responses/BadRequestError'
    get:
      summary: Get all projects for the authenticated user.
      operationId: getProjects
      responses:
        "200":
          description: A list of projects.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProjectResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'

  /projects/{project_id}/sections:
    parameters:
      - in: path
        name: project_id
        schema:
          $ref: '#/components/schemas/UUID'
        required: true
        description: ID of the project to add a section to.
    post:
      summary: Create a new section within a project.
      operationId: createSectionInProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SectionCreate'
      responses:
        "201":
          description: Section created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SectionResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "400":
          $ref: '#/components/responses/BadRequestError'

  /tags:
    get:
      summary: Get all tags for the authenticated user.
      operationId: getTags
      responses:
        "200":
          description: List of tags.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TagResponse'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'


components:
  responses:
    UnauthorizedError:
      description: Authentication required.
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
                example: "Not authenticated"
    ForbiddenError:
      description: Not authorized to access this resource.
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
                example: "Not authorized"
    NotFoundError:
      description: Resource not found.
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
                example: "Task not found"
    BadRequestError:
      description: Invalid request payload or parameters.
      content:
        application/json:
          schema:
            type: object
            properties:
              detail:
                type: string
                example: "Invalid input"